<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta charset="utf-8">
	<title>API接口调试工具</title>
	<link href="css/bootstrap.css" type="text/css" rel="stylesheet">
    <link href="css/jsonview.css" type="text/css" rel="stylesheet">
    <link href="css/autocomplete.css" type="text/css" rel="stylesheet">
    <style>
        .input-group-btn .btn-default, .input-group-btn .btn-info, .input-group-btn .btn-success, .input-group-btn .btn-primary {
            height: 34px;
        }
        #result {
            border:none;
            height: 300px;
        }
        #input_method {
            border-radius: 0;
        }
        .highlight {
            margin-top: -16px;
            margin-right: 0;
            margin-left: 0;
            border-width: 1px;
            border-bottom-right-radius: 4px;
            border-bottom-left-radius: 4px;
        }
        .box {
            position: relative;
            border-radius: 3px;
            background: #ffffff;
            border-top: 3px solid #d2d6de;
            margin-bottom: 20px;
            width: 100%;
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }
        .box.box-info {
            border-top-color: #00c0ef;
        }
        .box-header {
            color: #444;
            display: block;
            padding: 10px;
            /*background: #d9f7ff;*/
            position: relative;
        }
        .box-header.with-border {
            border-bottom: 1px solid #f4f4f4;
        }
        .box-body {
            border-top-left-radius: 0;
            border-top-right-radius: 0;
            border-bottom-right-radius: 3px;
            border-bottom-left-radius: 3px;
        }
        .box-params, .box-env {
            width: 70%;
            text-align: center;
            /*margin-top: 12px;*/
            margin-left: 64px;
            margin-right: 120px;
        }
        .box-params .form-control, .box-env .form-control {
            width: 50%;
        }
		.params-item .params-value, .env-item .env-item-url {
			border-left: none;
		}
		#env_settings .input-group, #container_params .input-group {
			margin-bottom: 2px;
		}
    </style>
</head>
<body>
    <nav class="navbar navbar-inverse navbar-fixed-top">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="#">API接口调试工具</a>
            </div>
            <div id="navbar" class="collapse navbar-collapse">
                <ul class="nav navbar-nav">
                    <li><a href="#about">更多设置</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container" style="margin-top:60px;">
        <div class="btn-group" id="env_menu">
            <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
                <span class="current-env">测试环境</span> <span class="caret"></span>
            </button>
            <ul class="dropdown-menu">
                <li><a href="#">测试环境</a></li>
                <li><a href="#">预发布环境</a></li>
                <li><a href="#">线上正式环境</a></li>
            </ul>
        </div>
    </div>

    <div class="container" style="margin-top:120px;">
        <div class="box box-info">
            <div class="box-header with-border"></div>
            <div class="box-body">
                <div class="input-group">
                    <span class="input-group-addon">Action</span>
                    <input type="text" class="form-control" id="input_method">
                    <span class="input-group-btn">
                        <button class="btn btn-default" type="button" id="btn_params">参数</button>
                        <button class="btn btn-primary" type="button" id="btn_go"> GO </button>
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div class="container" style="margin-top:12px;display:none;" id="container_params">
        <div class="input-group box-params">
            <div class="params-item">
                <input type="text" class="form-control input-sm params-key" placeholder="key">
                <input type="text" class="form-control input-sm params-value" placeholder="value">
            </div>
            <span class="input-group-btn">
                <button class="btn btn-danger btn-sm" type="button">删除</button>
            </span>
        </div>
    </div>

    <div class="container" style="margin-top:120px;">
        <div class="box box-info">
            <div class="box-header">
                <div class="btn-group">
                    <button type="button" class="btn btn-default btn-sm">格式化</button>
                    <button type="button" class="btn btn-default btn-sm">原始数据</button>
                    <button type="button" class="btn btn-default btn-sm" data-toggle="modal" data-target="#settingsModal">接口配置管理</button>
                </div>
            </div>
            <div class="box-body">
                <pre id="result"></pre>
            </div>
        </div>
    </div>

    <div class="modal fade" id="settingsModal" tabindex="-1" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                        <span class="sr-only">Close</span>
                    </button>
                    <h4 class="modal-title" id="settingsModalLabel">接口配置管理</h4>
                </div>
                <div class="modal-body" id="env_settings">
                    <div class="input-group box-env">
                        <div class="env-item">
                            <input type="text" class="form-control input-sm env-item-name" placeholder="接口环境名称">
                            <input type="text" class="form-control input-sm env-item-url" placeholder="接口URL">
                        </div>
                        <span class="input-group-btn">
                            <button class="btn btn-danger btn-sm" type="button">删除</button>
                        </span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" id="btn_save_settings">保存配置</button>
                </div>
            </div>
        </div>
    </div>

	<script type="text/javascript" src="js/jquery.min.js"></script>
	<script type="text/javascript" src="js/bootstrap.js"></script>
    <script type="text/javascript" src="js/autocomplete.js"></script>
    <script type="text/javascript" src="js/jsonview.js"></script>
    <script type="text/javascript" src="js/webstorage.js"></script>
	<script type="text/javascript">

		$(document).ready(function(){
			//todo
			console.info('API接口调试工具');

            var sampleData = [
              'Alabama', 'Alaska', 'Arizona', 'Arkansas', 'California',
              'Colorado', 'Connecticut', 'Delaware', 'Florida', 'Georgia', 
              'Hawaii', 'Idaho', 'Illinois', 'Indiana', 'Iowa', 
              'Kansas', 'Kentucky', 'Louisiana', 'Maine', 'Maryland', 
              'Massachusetts', 'Michigan', 'Minnesota', 'Mississippi', 
              'Missouri', 'Montana', 'Nebraska', 'Nevada', 'New Hampshire',
              'New Jersey', 'New Mexico', 'New York', 'North Carolina', 
              'North Dakota', 'Ohio', 'Oklahoma', 'Oregon', 'Pennsylvania', 
              'Rhode Island', 'South Carolina', 'South Dakota', 'Tennessee', 
              'Texas', 'Utah', 'Vermont', 'Virginia', 'Washington', 
              'West Virginia', 'Wisconsin', 'Wyoming'
            ];

            var ApiTool = {};
			ApiTool.api_url = 'http://vm.boyaa.com/linux-dash/server/index.php?module=io_stats';

            //初始化设置面板
            //init_settings_modal();
            //初始化设置
            init_settings();

            $("#input_method").autocomplete({
                 source:[sampleData]
            });

            $("#btn_params").click(function(){
                $("#container_params").toggle();
            });

            $("#tabpage").click(function(e) {
                e.preventDefault();
                $(this).tab('show');
            });

            //接口环境菜单选项
            $("#env_menu .dropdown-menu").find("a").click(function() {
                var envname = $(this).html();
				var settings = webStorage.get('env_settings');

                if (settings) {
                    var len = settings.length;
                    for (var i=0; i<len; i++) {
                        if (envname == settings[i]['name']) {
							ApiTool.api_url = settings[i]['url'];
							break;
                        }
                    }
				}

				if(envname) {
                    $("#env_menu").find('.current-env').text(envname);
                }
            });

            $(document).on('click', '#container_params .box-params:last input', function(){
                var html = '';
                html += '<div class="input-group box-params">';
                html += '  <div class="params-item">';
                html += '    <input type="text" class="form-control input-sm params-key" placeholder="key">';
                html += '    <input type="text" class="form-control input-sm params-value" placeholder="value">';
                html += '  </div>';
                html += '  <span class="input-group-btn params-item-delete">';
                html += '    <button class="btn btn-danger btn-sm" type="button">删除</button>';
                html += '  </span>';
                html += '</div>';

                $("#container_params").append(html);
            });

            $(document).on('click', '#env_settings .env-item:last input', function(){
                var html = '';
                html += '<div class="input-group box-env">';
                html += '  <div class="env-item">';
                html += '    <input type="text" class="form-control input-sm env-item-name" placeholder="接口环境名称">';
                html += '    <input type="text" class="form-control input-sm env-item-url" placeholder="接口URL">';
                html += '  </div>';
                html += '  <span class="input-group-btn env-item-delete">';
                html += '    <button class="btn btn-danger btn-sm" type="button">删除</button>';
                html += '  </span>';
                html += '</div>';

                $("#env_settings").append(html);
            });

            $(document).on('click', '#container_params .params-item-delete', function(){
                $(this).parent().remove();
            });

            $(document).on('click', '#settingsModal .env-item-delete', function(){
                $(this).parent().remove();
            });

            $("#btn_go").click(function(){
                var params = get_params_data();

				if (ApiTool.api_url) {
					params['api_url'] = ApiTool.api_url;
				}

                //发送请求
                request('get.php', params, function(data){
                    $("#result").html(data);
                });
            });

            $(document).on('click', '#btn_save_settings', function(){
                var data = [];
                var env_settings = $("#env_settings .env-item");
                
                env_settings.each(function(){
                    var item = {};
                    var eleEnvItem = $(this);
                    item.name = eleEnvItem.find(".env-item-name:eq(0)").val();
                    item.url = eleEnvItem.find(".env-item-url:eq(0)").val();
                    if (item.name != '' && item.url != '') {
                        data.push(item);
                    }
                });

                webStorage.set('env_settings', data);
                $("#settingsModal").modal('hide');
            });

            function get_params_data() {
                var data = {};
                var params = $("#container_params .params-item");

                params.each(function(){
                    var eleParamsItem = $(this);
                    var key = eleParamsItem.find(".params-key:eq(0)").val();
                    var value = eleParamsItem.find(".params-value:eq(0)").val();

                    if (key != '') {
                        data[key] = value;
                    }
                });

                return data;
            }

            function init_settings_modal() {
                var html = '';
                html += '<div class="modal fade" id="setttingsModal" tabindex="-1" role="dialog">';
                html += '  <div class="modal-dialog">';
                html += '    <div class="modal-content">';
                html += '      <div class="modal-header">';
                html += '        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>';
                html += '        <h4 class="modal-title" id="myModalLabel">Modal title</h4>';
                html += '      </div>';
                html += '      <div class="modal-body"></div>';
                html += '      <div class="modal-footer">';
                html += '        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>';
                html += '        <button type="button" class="btn btn-primary">Save changes</button>';
                html += '      </div>';
                html += '    </div>';
                html += '  </div>';
                html += '</div>';
                
                $('body').append(html);
            }

            function get_env_item_html(item) {
                var html = '';

                html += '<div class="input-group box-env">';
                html += '  <div class="env-item">';
                html += '    <input type="text" value="' + item.name + '" class="form-control input-sm env-item-name" placeholder="接口环境名称">';
                html += '    <input type="text" value="' + item.url + '" class="form-control input-sm env-item-url" placeholder="接口URL">';
                html += '  </div>';
                html += '  <span class="input-group-btn env-item-delete">';
                html += '    <button class="btn btn-danger btn-sm" type="button">删除</button>';
                html += '  </span>';
                html += '</div>';

                return html;
            }
            
            function get_env_menu_html(item) {
                var html = '';

                html += '<li><a href="#">' + item.name + '</a></li>';

                return html;
            }

            function init_settings() {
                var env_settings_html = '';
                var env_menu_html = '';
                var current_env = '';
                var settings = webStorage.get('env_settings');
                
                if (settings) {
                    var len = settings.length;
                    for (var i=0; i<len; i++) {
                        if (i == 0) {
                            current_env = settings[i]['name'];
							ApiTool.api_url = settings[i]['url'];
                        }
                        env_settings_html += get_env_item_html(settings[i]);
                        env_menu_html += get_env_menu_html(settings[i]);
                    }

                    $("#env_settings").html(env_settings_html);
                    $("#env_menu").find('.current-env').text(current_env);
                    $("#env_menu .dropdown-menu").html(env_menu_html);
                }
            }

            function request(url, params, callback) {
                $.get(url, params, function(data){

                        var output = data;
                        var cleanData = '';
                        var callbackData = '';
						var jsonRegex = /^\s*([\[\{].*[\}\]])\s*$/;
						var jsonpRegex = /^[\s\u200B\uFEFF]*([\w$\[\]\.]+)[\s\u200B\uFEFF]*\([\s\u200B\uFEFF]*([\[{][\s\S]*[\]}])[\s\u200B\uFEFF]*\);?[\s\u200B\uFEFF]*$/;
						var jsonpRegex2 = /([\[\{][\s\S]*[\]\}])\);/ // more liberal support
						var isJson = jsonRegex.test(data);
						var isJsonp = jsonpRegex.test(data);

                        var callback_results = jsonpRegex.exec(data);
                        if (callback_results && callback_results.length == 3) {
                            //console.log("THIS IS JSONP");
                            callbackData = callback_results[1];
                            cleanData = callback_results[2];
                        } else if (isJson) {
                            //console.log("Vanilla JSON");
                            cleanData = data;
                        }

                        // Covert, and catch exceptions on failure
                        try {
                            // var jsonObj = this.nativeJSON.decode(cleanData);
							if (isJson || isJsonp) {
								var jsonObj = JSON.parse(cleanData);
								if ( jsonObj ) {
								  output = jsonFormatter.jsonToHTML(jsonObj, callbackData, url);
								} else {
								  throw "There was no object!";
								}
							}
                            //callback
                            if (callback) {
                                callback(output);
                            }
                        } catch(e) {
                            console.log(e);
                            output = jsonFormatter.errorPage(e, data, url);
                        }
                });
            }
		});
	</script>
</body>
</html>