<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta charset="utf-8">
	<title>API接口调试工具</title>
	<link href="css/bootstrap.css" type="text/css" rel="stylesheet">
    <link href="css/jsonview.css" type="text/css" rel="stylesheet">
    <link href="css/autocomplete.css" type="text/css" rel="stylesheet">
    <style>

		/*Chrome滚动条样式*/
		::-webkit-scrollbar {
			width: 8px;
			height: 8px;

		}
		::-webkit-scrollbar-track {
			-webkit-box-shadow: inset 0 0 1px rgba(0,0,0,0.5);
			border-radius: 4px;
		}
		::-webkit-scrollbar-thumb {
			border-radius: 4px;
			-webkit-box-shadow: inset 0 0 1px rgba(0,0,0,.5);
			background-color: #337ab7;
		}

        .input-group-btn .btn-default, .input-group-btn .btn-info, 
		.input-group-btn .btn-success, .input-group-btn .btn-primary {
            height: 34px;
        }
        #result {
			height: 480px;
            border:none;
			background: #f6f6f6;
            border-radius: 0;
        }
        #input_method {
            border-radius: 0;
        }
		#env_menu {
			float: right;
		}
		#container_params {
			display: none;
			margin-top: 12px;
			margin-bottom: 12px;
		}
        .highlight {
            margin-top: -16px;
            margin-right: 0;
            margin-left: 0;
            border-width: 1px;
            border-bottom-right-radius: 4px;
            border-bottom-left-radius: 4px;
        }
        .box {
			float: left;
			width: 100%;
            background: #f2f2f2;
            border-top: 3px solid #d2d6de;
            margin-bottom: 20px;
        }
        .box.box-info {
            border-top-color: #337ab7;
        }
        .box-header {
            color: #444;
            display: block;
            padding: 10px;
            position: relative;
        }
        .box-params, .box-env {
            width: 90%;
            margin-left: 5%;
        }
        .box-params .form-control, .box-env .form-control {
            width: 50%;
        }
		.params-item .params-value, .env-item .env-item-url {
			border-left: none;
		}
		#env_settings .input-group, #container_params .input-group {
			margin-bottom: 2px;
		}
    </style>
</head>
<body>
    <nav class="navbar navbar-inverse navbar-fixed-top">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="#">API接口调试工具</a>
            </div>
            <div id="navbar" class="collapse navbar-collapse">
                <ul class="nav navbar-nav">
                    <li><a href="#about"></a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container" style="margin-top:60px;">
        <div class="btn-group" id="env_menu">
            <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
                <span class="current-env">测试环境</span> <span class="caret"></span>
            </button>
            <ul class="dropdown-menu">
                <li><a href="#">测试环境</a></li>
            </ul>
        </div>
    </div>

    <div class="container" style="margin-top:60px;">
        <div class="box box-info">
            <div class="box-body">
                <div class="input-group" style="margin:8px;">
                    <span class="input-group-addon">Action</span>
                    <input type="text" class="form-control" id="input_method">
                    <span class="input-group-btn">
                        <button class="btn btn-default" type="button" id="btn_params">参数</button>
                        <button class="btn btn-primary" type="button" id="btn_go"> GO </button>
                    </span>
                </div>

				<div id="container_params">
					<div class="input-group box-params">
						<div class="params-item">
							<input type="text" class="form-control input-sm params-key" placeholder="key">
							<input type="text" class="form-control input-sm params-value" placeholder="value">
						</div>
						<span class="input-group-btn">
							<button class="btn btn-danger btn-sm" type="button">删除</button>
						</span>
					</div>
				</div>
            </div>
        </div>
    </div>

    <div class="container" style="margin-top:120px;">
        <div class="box box-info">
            <div class="box-header">
                <div class="btn-group">
                    <button type="button" class="btn btn-default btn-sm">格式化</button>
                    <button type="button" class="btn btn-default btn-sm">原始数据</button>
                    <button type="button" class="btn btn-default btn-sm" id="btn_settings">接口配置管理</button>
                </div>
            </div>
            <div class="box-body">
                <pre id="result"></pre>
            </div>
        </div>
    </div>

	<script type="text/javascript" src="js/jquery.min.js"></script>
	<script type="text/javascript" src="js/bootstrap.js"></script>
    <script type="text/javascript" src="js/autocomplete.js"></script>
    <script type="text/javascript" src="js/jsonview.js"></script>
    <script type="text/javascript" src="js/webstorage.js"></script>
	<script type="text/javascript" src="js/methods.js"></script>
	<script type="text/javascript">

		$(document).ready(function(){
			//todo
			console.info('API接口调试工具');

            var ApiTool = {};
			var jsonFormatter = new JSONFormatter();
			ApiTool.api_url = '';

            //初始化设置面板
            init_settings_modal();
			//初始获取SESSID面板
			init_get_sessid_modal();
            //初始化设置
            init_settings();

            $("#input_method").autocomplete({
				openOnFocus:true,
                source:[apiListData]
            });

            $("#btn_params").click(function(){
                $("#container_params").toggle();
            });

            $("#tabpage").click(function(e) {
                e.preventDefault();
                $(this).tab('show');
            });

            //接口环境菜单选项
            $("#env_menu .dropdown-menu").find("a").click(function() {
                var envname = $(this).html();
				var settings = webStorage.get('env_settings');

                if (settings) {
                    var len = settings.length;
                    for (var i=0; i<len; i++) {
                        if (envname == settings[i]['name']) {
							ApiTool.api_url = settings[i]['url'];
							break;
                        }
                    }
				}

				if(envname) {
                    $("#env_menu").find('.current-env').text(envname);
                }
            });

            $(document).on('click', '#container_params .box-params:last input', function(){
                var html = '';
                html += '<div class="input-group box-params">';
                html += '  <div class="params-item">';
                html += '    <input type="text" class="form-control input-sm params-key" placeholder="key">';
                html += '    <input type="text" class="form-control input-sm params-value" placeholder="value">';
                html += '  </div>';
                html += '  <span class="input-group-btn params-item-delete">';
                html += '    <button class="btn btn-danger btn-sm" type="button">删除</button>';
                html += '  </span>';
                html += '</div>';

                $("#container_params").append(html);
            });

			$(document).on('click', '#container_params .params-value', function(){
                var parent = $(this).parent();
				var paramKey = parent.find(".params-key:eq(0)").val();

				if (paramKey == 'ssid') {
					$("#getSessidModal").modal('show');
				}
            });

            $(document).on('click', '#env_settings .env-item:last input', function(){
                var html = '';
                html += '<div class="input-group box-env">';
                html += '  <div class="env-item">';
                html += '    <input type="text" class="form-control input-sm env-item-name" placeholder="接口环境名称">';
                html += '    <input type="text" class="form-control input-sm env-item-url" placeholder="接口URL">';
                html += '  </div>';
                html += '  <span class="input-group-btn env-item-delete">';
                html += '    <button class="btn btn-danger btn-sm" type="button">删除</button>';
                html += '  </span>';
                html += '</div>';

                $("#env_settings").append(html);
            });

            $(document).on('click', '#container_params .params-item-delete', function(){
                $(this).parent().remove();
            });

            $(document).on('click', '#settingsModal .env-item-delete', function(){
                $(this).parent().remove();
            });

            $("#btn_go").click(function(){
                var params = get_params_data();
				var apiMethod = $("#input_method").val();

				if (apiMethod) {
					params['action'] = apiMethod;
				}

				if (ApiTool.api_url) {
					params['api_url'] = ApiTool.api_url;
				}

                //发送请求
                request('get.php', params, function(data){
                    $("#result").html(data);
                });
            });

			$("#btn_settings").click(function(){
                $("#settingsModal").modal('show');
            });

            $(document).on('click', '#btn_save_settings', function(){
                var data = [];
                var env_settings = $("#env_settings .env-item");

                env_settings.each(function(){
                    var item = {};
                    var eleEnvItem = $(this);
                    item.name = eleEnvItem.find(".env-item-name:eq(0)").val();
                    item.url = eleEnvItem.find(".env-item-url:eq(0)").val();
                    if (item.name != '' && item.url != '') {
                        data.push(item);
                    }
                });

                webStorage.set('env_settings', data);
                $("#settingsModal").modal('hide');
            });

			$(document).on('click', '#btn_get_sessid', function(){
                var mid = $("#user_mid").val();

				if (mid) {
					get_user_sessid(mid, function(data){
						if (data['result']) {
							$("#container_params .params-key").each(function(){
								var that = $(this);
								if (that.val() == 'ssid') {
									that.parent().find(".params-value").val(data['result']);
								}
							});
							$("#getSessidModal").modal('hide');
						}
					});
				}
            });

            function get_params_data() {
                var data = {};
                var params = $("#container_params .params-item");

                params.each(function(){
                    var eleParamsItem = $(this);
                    var key = eleParamsItem.find(".params-key:eq(0)").val();
                    var value = eleParamsItem.find(".params-value:eq(0)").val();

                    if (key != '') {
                        data[key] = value;
                    }
                });

                return data;
            }

			function init_settings_modal() {
                var html = '';
                html += '<div class="modal fade" id="settingsModal" tabindex="-1" role="dialog">';
                html += '  <div class="modal-dialog">';
                html += '    <div class="modal-content">';
                html += '      <div class="modal-header">';
                html += '        <button type="button" class="close" data-dismiss="modal">';
				html += '			<span aria-hidden="true">&times;</span><span class="sr-only">Close</span>';
				html += '		 </button>';
                html += '        <h4 class="modal-title" id="settingsModalLabel">接口配置管理</h4>';
                html += '      </div>';
                html += '      <div class="modal-body" id="env_settings">';
				html += '		 <div class="input-group box-env">';
				html += '          <div class="env-item">';
				html += '            <input type="text" class="form-control input-sm env-item-name" placeholder="接口环境名称">';
				html += '            <input type="text" class="form-control input-sm env-item-url" placeholder="接口URL">';
				html += '          </div>';
				html += '          <span class="input-group-btn">';
				html += '            <button class="btn btn-danger btn-sm" type="button">删除</button>';
				html += '          </span>';
				html += '        </div>';
				html += '      </div>';
                html += '      <div class="modal-footer">';
                html += '        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>';
                html += '        <button type="button" class="btn btn-primary">保存配置</button>';
                html += '      </div>';
                html += '    </div>';
                html += '  </div>';
                html += '</div>';

                $('body').append(html);
            }

            function init_get_sessid_modal() {
                var html = '';
                html += '<div class="modal fade" id="getSessidModal" tabindex="-1" role="dialog">';
                html += '  <div class="modal-dialog">';
                html += '    <div class="modal-content">';
                html += '      <div class="modal-header">';
                html += '        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>';
                html += '        <h4 class="modal-title" id="getSessidModalLabel">获取用户SESSID</h4>';
                html += '      </div>';
                html += '      <div class="modal-body">';
				html += '		 <div class="input-group" style="width:90%;margin-left:5%;">';
				html += '          <div class="">';
				html += '            <input type="text" class="form-control user-mid" placeholder="用户MID" id="user_mid">';
				html += '          </div>';
				html += '          <span class="input-group-btn">';
				html += '            <button class="btn btn-default" type="button" id="btn_get_sessid">获取SSID</button>';
				html += '          </span>';
				html += '        </div>';
				html += '	   </div>';
                //html += '      <div class="modal-footer">';
                //html += '        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>';
                //html += '        <button type="button" class="btn btn-primary" id="btn_set_ssid"> 确定 </button>';
                //html += '      </div>';
                html += '    </div>';
                html += '  </div>';
                html += '</div>';

                $('body').append(html);
            }

            function get_env_item_html(item) {
                var html = '';

                html += '<div class="input-group box-env">';
                html += '  <div class="env-item">';
                html += '    <input type="text" value="' + item.name + '" class="form-control input-sm env-item-name" placeholder="接口环境名称">';
                html += '    <input type="text" value="' + item.url + '" class="form-control input-sm env-item-url" placeholder="接口URL">';
                html += '  </div>';
                html += '  <span class="input-group-btn env-item-delete">';
                html += '    <button class="btn btn-danger btn-sm" type="button">删除</button>';
                html += '  </span>';
                html += '</div>';

                return html;
            }
            
            function get_env_menu_html(item) {
                var html = '';

                html += '<li><a href="#">' + item.name + '</a></li>';

                return html;
            }

            function init_settings() {
                var env_settings_html = '';
                var env_menu_html = '';
                var current_env = '';
                var settings = webStorage.get('env_settings');
                
                if (settings) {
                    var len = settings.length;
                    for (var i=0; i<len; i++) {
                        if (i == 0) {
                            current_env = settings[i]['name'];
							ApiTool.api_url = settings[i]['url'];
                        }
                        env_settings_html += get_env_item_html(settings[i]);
                        env_menu_html += get_env_menu_html(settings[i]);
                    }

                    $("#env_settings").html(env_settings_html);
                    $("#env_menu").find('.current-env').text(current_env);
                    $("#env_menu .dropdown-menu").html(env_menu_html);
                }
            }

			function get_user_sessid(mid, callback) {
				var url = ApiTool.api_url;
				var params = {};
				params['action'] = 'apitool.getUserSessId';
				params['mid'] = mid;
                $.get(url, params, function(data){

                        console.log(data);
						callback(data);
                });
            }

            function request(url, params, callback) {
                $.get(url, params, function(data){

                        var output = data;
                        var cleanData = '';
                        var callbackData = '';
						var jsonRegex = /^\s*([\[\{].*[\}\]])\s*$/;
						var jsonpRegex = /^[\s\u200B\uFEFF]*([\w$\[\]\.]+)[\s\u200B\uFEFF]*\([\s\u200B\uFEFF]*([\[{][\s\S]*[\]}])[\s\u200B\uFEFF]*\);?[\s\u200B\uFEFF]*$/;
						var jsonpRegex2 = /([\[\{][\s\S]*[\]\}])\);/ // more liberal support
						var isJson = jsonRegex.test(data);
						var isJsonp = jsonpRegex.test(data);

                        var callback_results = jsonpRegex.exec(data);
                        if (callback_results && callback_results.length == 3) {
                            //console.log("THIS IS JSONP");
                            callbackData = callback_results[1];
                            cleanData = callback_results[2];
                        } else if (isJson) {
                            //console.log("Vanilla JSON");
                            cleanData = data;
                        }

                        // Covert, and catch exceptions on failure
                        try {
                            // var jsonObj = this.nativeJSON.decode(cleanData);
							if (isJson || isJsonp) {
								var jsonObj = JSON.parse(cleanData);
								if ( jsonObj ) {
								  output = jsonFormatter.jsonToHTML(jsonObj, callbackData, url);
								} else {
								  throw "There was no object!";
								}
							}
                            //callback
                            if (callback) {
                                callback(output);
                            }
                        } catch(e) {
                            console.log(e);
                            output = jsonFormatter.errorPage(e, data, url);
                        }
                });
            }
		});
	</script>
</body>
</html>